---
weight: 40
title: Alarms generated by the Apama-ctrl microservice
layout: redirect
---

Alarms are created by user applications in the Cumulocity IoT tenant (for example, by a smart rule, an Analytics Builder model, or an activated EPL file). To learn about alarms in general, refer to [Working with alarms](/users-guide/device-management/#alarm-monitoring) in the *User guide*. The Apama-ctrl microservice also generates alarms because it has encountered some problem. For example, if the Apama license is about to expire, the Apama-ctrl microservice generates an alarm to the platform, so that the user is notified about the situation. The information below is about alarms that are generated by the Apama-ctrl microservice, their causes, consequences and possible ways to resolve them.

> **Info:** Alarms generated by Apama-ctrl about its own state are available as of Apama Analytics Builder 10.5.0 and Apama EPL Apps 10.5.0.
>

 You can view alarms in the following ways:

1. In the Cockpit application. See [Cockpit](/users-guide/cockpit/) in the *User guide* for detailed information.
2. In the Administration application, in the **Applications** menu under **Subscribed applications** (or possibly under **Own applications**). Click the card for Apama-ctrl and then click **Status**. See [Managing applications](/users-guide/administration/#managing-applications) and especially its subsection *Monitoring microservices* in the *User guide* for detailed information.
3. From the Apama EPL Apps and Apama Analytics Builder applications. Click the **Diagnostics** (or **Enhanced**) link which is provided with both applications. A ZIP file is then downloaded that contains alarms information under */alarm/alarms_apama-ctrl-object.json*. See [Downloading diagnostics and logs](#diagnostics-download) for detailed information.

### Alarm severities

| Severity | Description                                                  |
| -------- | ------------------------------------------------------------ |
| CRITICAL | Apama-ctrl was unable to continue running the user's applications and will require corrective action. |
| MAJOR    | Apama-ctrl has encountered a situation that will result in some loss of service (for example, due to a restart). |
| MINOR    | Apama-ctrl has a problem that you might want to fix.         |
| WARNING  | There is a warning.                                          |

### Alarms created by the Apama-ctrl microservice

Apama-ctrl can create alarms to notify users in scenarios such as Apama license expiry, the correlator running out of memory, uncaught exceptions in activated EPL files, etc. Once you see an alarm in the Cumulocity IoT tenant, you should diagnose it and resolve it depending on the severity level of the raised alarm. Each alarm has details such as title, text, type, date, and count (represents the number of times the alarm has been raised).

The following is a list of the alarms. The information further down below explains when these alarms will occur, their consequences, and how to resolve them.

- [Change in tenant options and restart of Apama-ctrl](#tenant_option_change)
- [No license found on startup](#apama_license_none)
- [License change and restart of Apama-ctrl](#apama_license_found)
- [License expiry](#apama_licenseexpiry)
- [Safe mode on startup](#apama_safe_mode)
- [Deactivating models in Apama Starter](#apama_ctrl_starter)
- [High memory usage](#apama_highmemoryusage)
- [Warning or higher level logging from an EPL file](#apama_ctrl_fatalcritwarn)
- [An EPL file throws an uncaught exception](#apama_ctrl_error)
- [An EPL file blocks the correlator context for too long](#apama_ctrl_warn)
- [Invalid measurement format](#apama_measurementformat_invalid)
- [Multiple extensions with the same name](#extension_error)
- [Connection to correlator lost](#lost_correlator_connection)
- [The correlator queue is full](#application_queue_full)
- [The CEP queue is full](#cep_queue_full) (this alarm is coming from Cumulocity IoT Core, but concerns Apama-ctrl)

Once the cause of an alarm is resolved, you have to acknowledge and clear the alarm in the Cumulocity IoT tenant. Otherwise, you will continue to see the alarm until a further restart of the Apama-ctrl microservice.

> **Info:** The alarm texts for the alarms below may undergo minor changes in the future.

#### <a name="tenant_option_change"></a>Change in tenant options and restart of Apama-ctrl

This alarm is raised only when a tenant option changes in the `analytics.builder` category. For details on the tenant options, refer to [Option](/reference/tenants/#option) in the *Reference guide*.

- Alarm type: `tenant_option_change`
- Alarm text: Apama detected changes in tenant option. Apama will restart in order to use it.
- Alarm severity: MAJOR

Apama Analytics Builder allows you to configure its settings by changing the tenant options, using key names such as `numWorkerThreads` or `status_device_name`. For example, if you want to process things in parallel, you can set `numWorkerThreads` to 3 by sending a REST request to Cumulocity IoT, which will update the tenant option. Such a change requires a restart of the Apama-ctrl microservice. To notify the users about the restart, Apama-ctrl raises an alarm, saying that Apama has detected a change in a tenant option and will restart in order to use it.

Once you see this alarm, you can be sure that your change is effective.

#### <a name="apama_license_none"></a>No license found on startup

This alarm is raised when the correlator cannot find a valid Apama license. Software AG provides an Apama license file for use during the product installation. For more details, see [About Apama license files](https://documentation.softwareag.com/onlinehelp/Rohan/Apama/v10-5/apama10-5/apama-webhelp/index.html#page/apama-webhelp%2Fco-IntToApa_about_apama_license_files.html) in the Apama documentation.

- Alarm type: `apama_license_none`
- Alarm text: Apama has not been able to find a license, and will run with very limited capabilities. Please contact support or your administrator.
- Alarm severity: MAJOR

The Apama correlator looks for a license key during its startup. If a license key is not found, the correlator continues to run with limited capabilities, such as restrictions on the number of EPL monitors, query definitions, etc. For more details on the limited capabilities, refer to [Running Apama without a license file](https://documentation.softwareag.com/onlinehelp/Rohan/Apama/v10-5/apama10-5/apama-webhelp/index.html#page/apama-webhelp%2Fco-IntToApa_running_apama_without_a_license_file.html) in the Apama documentation.

When a valid Apama license is not found, an alarm of MAJOR severity with the above type and text is raised by the Apama-ctrl microservice. You can either continue without an Apama license with limited capabilities or upload a valid Apama license file to get the full functionality of Apama EPL Apps and Apama Analytics Builder. For getting a license, refer to [License file](https://documentation.softwareag.com/onlinehelp/Rohan/Apama/v10-5/apama10-5/apama-webhelp/index.html#page/apama-webhelp%2Fco-InsApa_license_file.html) in the Apama documentation.

#### <a name="apama_license_found"></a>License change and restart of Apama-ctrl

This alarm is raised when Apama-ctrl restarts due to license changes.

- Alarm type: `apama_license_found`
- Alarm text: An Apama license has now been found. Apama will restart in order to use it.
- Alarm severity: MINOR

The Apama-ctrl microservice detects changes in the license file. To apply the latest changes, the Apama-ctrl microservice has to be restarted. To notify the users about the restart, the microservice raises an alarm with MINOR severity.

It is recommended that you also check for any other alarms after the restart, just to make sure Apama-ctrl is able to start with the new license.

#### <a name="apama_licenseexpiry"></a>License expiry

This alarm is raised when the license is about to expire. It is repeated seven days prior to the license expiry date.

- Alarm type: `apama_licenseexpiry`
- Alarm text: The Apama license will expire at &lt;expiry-date&gt;. Please contact support or your administrator.
- Alarm severity: WARNING

The Apama license key has the expiry date as one of its parameters. During the startup process, the Apama-ctrl microservice checks the license expiry date against the current date and raises an alarm with WARNING severity seven days prior to the expiry date. In order to continue without any intervention, you should renew the license before the expiry date. If the license expires, there is a grace period of seven days, beyond which the correlator will exit and kill the microservice.

Currently, when the Apama-ctrl microservice goes down due to license expiry, it generates an alarm with a generic message saying "Apama has exited unexpectedly. As a precaution, user-provided EPL and Analytics Builder models that might have caused this have been disabled, refer to the audit log for more details. Please check any recent alarms, or contact support or your administrator".

Refer to Software AG support or the *Operations guide* (available from the [Software AG Empower Product Support](https://empower.softwareag.com/) website) for how to upload a new license file. After uploading a new license file, you have to re-start the Apama-ctrl microservice manually.

You can view the license information using the diagnostics information as described in [Downloading diagnostics and logs](#diagnostics-download). When you click the **Diagnostics** link, a ZIP file is downloaded which contains license information in the file */info/license.json*.

#### <a name="apama_safe_mode"></a>Safe mode on startup

This alarm is raised whenever the Apama-ctrl microservice switches to Safe mode.

- Alarm type: `apama_safe_mode`
- Alarm text: Apama has exited unexpectedly. As a precaution, user-provided EPL, Analytics Builder models and extensions that might have caused this have been disabled. Refer to the audit log for more details. Please check any recent alarms, or contact support or your administrator.
- Alarm severity: CRITICAL

In the case of unexpected restarts, Apama-ctrl assumes that they may have been caused by user error. For example, an EPL app that consumes more memory than is available, or an extension containing bugs. To avoid an infinite restart loop caused by these errors, Safe mode is activated, resulting in all user-provided content being disabled.

The microservice checks on every restart if it has restarted in the last 20 minutes. If so, the microservice considers the restart as unexpected and enables Safe mode. Otherwise, it treats the restart as a normal restart. Safe mode can be erroneously triggered by the user manually unsubscribing and resubscribing the microservice too quickly, or by problems in the hosting infrastructure that cause frequent restarts.

You can check the mode of the microservice (either Normal or Safe mode) by making a REST request to *service/cep/diagnostics/apamaCtrlStatus* (available as of Apama EPL Apps 10.5.7 and Apama Analytics Builder 10.5.7), which contains a `safe_mode` flag in its response.

To diagnose the cause of an unexpected restart, you can try the following:

- Check the Apama EPL Apps memory profiler, by making a REST request to */service/cep/diagnostics/eplMemoryProfiler* (available as of Apama EPL Apps 10.5.7) for any memory leaks.

    Note that you have to re-activate the EPL apps that were active before as the Apama-ctrl microservice loses information about the previous microservice instance when it restarts due to Safe mode. To replicate the previous scenario, run the EPL apps and process some events to trigger a leak and then use the memory profiler to check for any memory leaks.

- Check the microservice logs for any exceptions by downloading the diagnostics overview ZIP file as described in [Downloading diagnostics and logs](#diagnostics-download). In the downloaded ZIP file, you can find the logs under */diagnostics/*.

    As mentioned in the above point, re-activate the EPL apps and Analytics Builder models that were active before and then check the logs.

- Also check for license expiry.
- Check the audit logs.

In Safe mode, all previously active Apama Analytics Builder models and Apama EPL apps are deactivated and must be manually re-activated.

#### <a name="apama_ctrl_starter"></a>Deactivating models in Apama Starter

This alarm is raised when Apama-ctrl switches from the licensed microservice to Apama Starter with more than 3 active models.

- Alarm type: `apama_ctrl_starter`
- Alarm text: The following models were de-activated as Apama Starter is restricted to 3 active models: (&lt;models&gt;).
- Alarm severity: MINOR

In Apama Starter, a user can have a maximum of 3 active models. For example, a user is working with the licensed Apama-ctrl microservice and has 5 active models, and then switches to Apama Starter. Since Apama Starter does not allow more than 3 active models, it deactivates all the active models (5) and raises an alarm to notify the user.

#### <a name="apama_highmemoryusage"></a>High memory usage

This alarm is raised whenever the correlator consumes 90% of the maximum memory permitted for the microservice container. During this time, the Apama-ctrl microservice automatically generates the diagnostics overview ZIP file which contains diagnostics information used for identifying the most likely cause for memory consumption.

There are 3 variants of this alarm, depending on the time and count restrictions of the generated diagnostics overview ZIP file.

First variant:

- Alarm type: `apama_highmemoryusage`
- Alarm text: Apama is using 90% of available memory (&lt;totalMemory&gt;). Your apps will be in danger of crashing. Diagnostics file is located at &lt;URL-to-ZIP-file&gt; You can also download the file by navigating to Administration > Management > Files Repository
- Alarm severity: WARNING

Second variant:

- Alarm type: `apama_highmemoryusage`
- Alarm text: Apama is using 90% of available memory (&lt;totalMemory&gt;). Your apps will be in danger of crashing. Have recently created diagnostics snapshot (within last hour).
- Alarm severity: WARNING

Third variant:

- Alarm type: `apama_highmemoryusage`
- Alarm text: Apama is using 90% of available memory (&lt;totalMemory&gt;). Your apps will be in danger of crashing. Have created 5 diagnostics snapshots, not creating any more, refer to past alarms.
- Alarm severity: WARNING

Running Apama EPL Apps (and to a lesser extent, smart rules and Analytics Builder) consumes memory, the amount will depend a lot on the nature of the app running. The memory usage should be approximately constant for a given set of apps, but it is possible to create a "memory leak", particularly in an EPL file or a custom block. The Apama-ctrl microservice monitors memory and raises an alarm with WARNING severity if the 90% memory limit is reached along with the diagnostics overview ZIP file and saves it to the files repository (as mentioned in the alarm text).

Apama-ctrl generates the diagnostics overview ZIP files with the following conditions:

- Only if it has not been generated in the last 1 hour.
- A maximum of 5 diagnostics overview ZIP files from its start time until it stops.
- Overall, it can generate a maximum of 20 ZIP files per Cumulocity IoT tenant, beyond which it keeps deleting the oldest ZIP files during its startup process.

To diagnose high-memory-consuming models and EPL apps, you can try the following (it could be listener leaks, excessive state being stored or spawned monitors leaking, etc.):

- Download the automatically generated diagnostics overview ZIP file (refer to the alarm text for its location) and look at *correlator/inspect.json* and *correlator/status.json* for the number of listeners (this number may be large in the case of a listener leak). Note that this is only an overview and excludes the EPL memory profile output.

- Download diagnostics information from Apama EPL Apps and Apama Analytics Builder using the **Diagnostics** link (as described in [Downloading diagnostics and logs](#diagnostics-download)). When using the **Enhanced** link, the diagnostics information includes (in addition to the information that you get with the **Diagnostics** link) requests that are more resource-intensive and may significantly slow down the correlator, including EPL memory profiler snapshots and the contents of the queues. So when diagnosing the cause for the first time, it is recommended to use the overview ZIP file from the **Diagnostics** link, unless additional information is required.

- The EPL memory profiler from the above **Enhanced** link in */diagnostics/eplMemoryProfiler.csv* gives the memory consumed by each monitor along with details such as the number of listeners or the number of monitor instances running something like shown in the snippet below. This can help you to understand which monitor is consuming more memory and try to reduce it.

    | Monitor | Monitor instances | EPL objects | Listeners | Bytes   | Overhead bytes |
    | ------- | ----------------- | ----------- | --------- | ------- | -------------- |
    | mon1    | 1                 | 5384        | 4         | 1073908 | 383240         |
    | mon2    | 1                 | 2           | 2         | 696     | 2280           |
    | mon3    | 1                 | 4           | 1         | 840     | 752            |

- Also check for memory usage on all the input and output queues available from the **Enhanced** link in */diagnostics/toStringQueues.txt*.

If the memory continues to grow, then when it reaches the limit, the correlator will run out of memory and Apama-ctrl will shut down. To prevent the microservice from going down, you have to fix this as a priority.

See also the TECHniques blog post at [Diagnostic tools for Apama in Cumulocity IoT](http://techcommunity.softwareag.com/techniques-blog/-/blogs/apama-in-cumulocity-iot).

#### <a name="apama_ctrl_fatalcritwarn"></a>Warning or higher level logging from an EPL file

This alarm is raised whenever messages are logged by Apama EPL files with specific log levels (including CRITICAL, FATAL, ERROR and WARNING).

Apama EPL Apps allows you to deploy EPL files to the correlator. The Apama-ctrl microservice analyzes logged content in the EPL files and raises an alarm for specific log levels with details such as monitor name, log text and alarm type (either of WARNING or MAJOR), based on the log level.

For example, the following is a simple monitor which prints a sequence and logs some texts at different EPL log levels.

```java
monitor Sample{
   action onload() {
      log "Info"; // default log level is now INFO
      log "Fatal Error" at FATAL; // log level is FATAL
      log "Critical Error" at CRIT; // log level is CRITICAL
      log "Warning" at WARN; // log level is WARNING
   }
}
```

Apama-ctrl analyzes all the log messages, filters out only certain log messages, and raises an alarm for the identified ones. Thus, Apama-ctrl generates the following three alarms for the above example:

First alarm:

- Alarm type: `APAMA_CTRL_FATAL_<HASHCODE>`
- Alarm text: &lt;Monitor name&gt;-Fatal Error.
- Alarm severity: MAJOR

Second alarm:

- Alarm type: `APAMA_CTRL_CRIT_<HASHCODE>`
- Alarm text:&lt;Monitor name&gt;-Critical Error.
- Alarm severity: MAJOR

Third alarm:

- Alarm type: `APAMA_CTRL_WARN_<HASHCODE>`
- Alarm text: &lt;Monitor name&gt;-Warning.
- Alarm severity: WARNING

#### <a name="apama_ctrl_error"></a>An EPL file throws an uncaught exception

You have seen that the Apama-ctrl microservice raises alarms for logged messages. In addition, there can also be uncaught exceptions (during runtime). Apama-ctrl identifies such exceptions and raises alarms so that you can identify and fix the problem.

For example, the following monitor throws `IndexOutOfBoundsException` during runtime:

```java
monitor Sample{
   sequence<string> values := ["10", "20", "30"];
   action onload() {
      // IndexOutOfBoundsException (runtime error)
      log "Value = " + values[10] at ERROR;
   }
}
```

Apama-ctrl generates the following alarm for the above example:

- Alarm type: `APAMA_CTRL_ERROR_<HASHCODE>`
- Alarm text: &lt;Monitor name&gt;-Error on line &lt;x&gt; of monitor : IndexOutOfBoundsException - Out of bounds index passed to sequence [] operator - Sample
- Alarm severity: MAJOR

You can diagnose the issue by the monitor name and line number given in the alarm.

For more details, you can also check the Apama logs if the tenant has the "microservice hosting" feature enabled. Alarms of this type should be fixed as a priority as these uncaught exceptions will terminate the execution of that monitor instance, which will typically mean that your app is not going to function correctly. This might even lead to a correlator crash if not handled properly.

#### <a name="apama_ctrl_warn"></a>An EPL file blocks the correlator context for too long

If an EPL app has an infinite loop, it may block the correlator context for too long, not letting any other apps run in the same context or, even worse, causes excessive memory usage (as the correlator is unable to perform any garbage collection cycles) leading to the app running out of memory. The Apama-ctrl microservice identifies such scenarios (the correlator logs warning messages if an app is blocking a context for too long) and raises alarms, so that the user can identify and fix the problem.

For example, the following monitor blocks the correlator main context:

```java
event MyEvent {
}

monitor Sample{
    action onload() {
        while true {
            // do something
            send MyEvent() to "foo";
        }
    }
}
```

Apama-ctrl generates the following alarm for the above example:

- Alarm type: `APAMA_CTRL_WARN_<HASHCODE>`
- Alarm text: &lt;EPLAppName&gt;.&lt;monitorName&gt; - context '&lt;contextName&gt;' has been processing a single event for a long time.
- Alarm severity: WARNING

You can diagnose the issue by the monitor name and context name given in the alarm.

For more details, you can also check the Apama logs if the tenant has the "microservice hosting" feature enabled. Alarms of this type should be fixed as a priority as these scenarios may lead to the microservice and correlator running out of memory.

#### <a name="apama_measurementformat_invalid"></a>Invalid measurement format

This alarm is raised whenever the `measurementFormat` key is set with an invalid value in the tenant option.

- Alarm type: `apama_measurementformat_invalid`
- Alarm text: The measurementFormat tenant option is set to an invalid value "&lt;value&gt;". Setting it to MEASUREMENT_ONLY.
- Alarm severity: WARNING

Valid `measurementFormat` values for any tenant are `MEASUREMENT_ONLY` and `BOTH`. The default value is `MEASUREMENT_ONLY`.

#### <a name="extension_error"></a>Multiple extensions with the same name

This alarm is raised when the Apama-ctrl microservice tries to activate the deployed extensions during its startup process and there are multiple extensions with the same name.

- Alarm type: `extension_error`
- Alarm text: Multiple extensions with the same name have been found: &lt;list of all duplicate extension names&gt;
- Alarm severity: CRITICAL

This disables all extensions that were deployed to Apama-ctrl. In order to use the deployed extensions, the user has to decide which extensions to keep and then delete the duplicate ones.

**Info:** In case of multiple duplicates, this alarm is only listed once.

#### <a name="lost_correlator_connection"></a>Connection to correlator lost

This alarm is raised in certain cases when the connection between the Apama-ctrl microservice and the correlator is lost. This should not happen, but can be triggered by high load situations.

- Alarm type: `lost_correlator_connection`
- Alarm text: Unable to ping correlator:  &lt;message&gt;, apama-ctrl will restart.

Apama-ctrl will automatically restart. Report this to [product support](/about-doc/contacting-support) if this is happening frequently.

#### <a name="application_queue_full"></a>The correlator queue is full

This alarm is raised whenever the correlator queue is full, including both input and output queues.

- Alarm type: `application_queue_full`
- Alarm text: InputQueueSize: &lt;size of input queue&gt;, OutputQueueSize: &lt;size of output queue&gt;, SlowestReceiver: &lt;name of the slowest receiver&gt;, SlowestReceiverQueueSize: &lt;size of slowest receiver's queue&gt;, SlowestContext: &lt;name of context with maximum pending events&gt;, SlowestContextQueueSize: &lt;size of slowest context's queue&gt;
- Alarm severity: CRITICAL

The correlator's input and output queues are periodically monitored to check for building up of events. If the pending queue size grows above the normal threshold (20,000 for the input queue and 10,000 for the output queue), an alarm is raised. The alarm text contains a snapshot of the correlator status at the time of raising the alarm. A correlator with a full input or output queue can cause a serious performance degradation.

The correlator queue size is based on the number of events, not raw bytes.

Check the alarm text to get an indication of which queue is blocking. This also contains information about the slowest receiver and the most backed-up context. To diagnose the cause, see the information given in [The CEP queue is full](#cep_queue_full). A problem is likely to trigger the "correlator queue is full" alarm followed by the "CEP queue is full" alarm.

#### <a name="cep_queue_full"></a>The CEP queue is full

This alarm is raised whenever the CEP queue for the respective tenant is full.

- Alarm text: Real-time event processing is currently overloaded and may stop processing your events. Please contact support.
- Alarm severity: CRITICAL

Karaf nodes that send events to the CEP engine maintain per-tenant queues for the incoming events. This data gets processed by the CEP engine for the hosted CEP rules. For various reasons, these queues can become full and cannot accommodate newly arriving data. In such cases, an alarm is sent to the platform so that the end users are notified about the situation.

If the CEP queue is full, older events are removed to handle new incoming events. To avoid this, you have to diagnose the cause of the queue being full and resolve it as soon as possible.

The CEP queue size is based on the number of CEP events, not raw bytes.

To diagnose the cause, you can try the following. It may be that the Apama-ctrl microservice is running slow because of time-consuming rules in the script, or the microservice is deprived of resources, or code is not optimized, etc. Check the input and output queues from the "correlator queue is full" alarm (or from the microservice logs or from the diagnostics overview ZIP file under */correlator/status.json*).

- If both input and output queues are full, this suggests a slow receiver, possibly EPL sending too many requests (or too expensive a request) to Cumulocity IoT.
- Else, if only the input queue is full, EPL is probably running in a tight loop. Try analyzing the *cpuProfile.csv* output in the diagnostic overview ZIP file, especially the monitor name and CPU time. The data collected in the profiler may also help in identifying other possible bottlenecks. For details, refer to [Using the CPU profiler](https://documentation.softwareag.com/onlinehelp/Rohan/Apama/v10-5/apama10-5/apama-webhelp/index.html#page/apama-webhelp%2Fta-DepAndManApaApp_using_the_cpu_profiler.html) in the Apama documentation.
- Else, the cause may be some issue with connectivity or in Cumulocity IoT Core.
